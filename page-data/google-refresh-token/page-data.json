{"componentChunkName":"component---src-templates-post-jsx","path":"/google-refresh-token/","result":{"data":{"site":{"siteMetadata":{"title":"나누면 배가 되고"}},"markdownRemark":{"id":"7b780208-a850-5305-a51c-f0937cbdaf93","excerpt":"Google은 Refresh Token을 쉽게 내주지 않는다. 우리 달록은 캘린더를 손쉽게 공유할 수 이다. 현재에는 우리 서비스 내에서만 일정이 등록 가능한 상태이다. 추후 확장성을 고려하여 와 연동하기 위해 Google에서 제공하는 token 정보를 관리해야 하는 요구사항이 추가 되었다. code를 활용한 AccessToken 및 IdToken 발급 …","html":"<h2>Google은 Refresh Token을 쉽게 내주지 않는다.</h2>\n<p>우리 <a href=\"https://github.com/woowacourse-teams/2022-dallog\">달록</a>은 캘린더를 손쉽게 공유할 수 <code class=\"language-text\">구독형 캘린더 공유 서비스</code>이다. 현재에는 우리 서비스 내에서만 일정이 등록 가능한 상태이다. 추후 확장성을 고려하여 <code class=\"language-text\">Google Calendar API</code>와 연동하기 위해 Google에서 제공하는 token 정보를 관리해야 하는 요구사항이 추가 되었다.</p>\n<h2>code를 활용한 AccessToken 및 IdToken 발급</h2>\n<p>Google은 OAuth 2.0 요청 때 적절한 <code class=\"language-text\">scope(e.g. openid)</code>를 추가하면 <code class=\"language-text\">OpenID Connect</code>를 통해 Google 리소스에 접근 가능한 <code class=\"language-text\">Access Token</code>, AccessToken을 재발급 받기 위한 <code class=\"language-text\">Refresh Token</code>, 회원의 정보가 담긴 <code class=\"language-text\">IdToken</code>을 발급해준다. </p>\n<p><code class=\"language-text\">Access Token</code>의 경우 짧은 만료 시간을 가지고 있기 때문에 google <code class=\"language-text\">Access Token</code> 재발급을 위한 <code class=\"language-text\">Refresh Token</code>을 저장하고 관리해야 한다. <code class=\"language-text\">Refresh Token</code>은 <code class=\"language-text\">Access Token</code>보다 긴 만료 시간을 가지고 있기 때문에 보안에 유의해야 한다. 그렇기 때문에 프론트 측에서 관리하는 것 보다 달록 DB에 저장한 뒤 관리하기로 결정 하였다. 참고로 Google은 보통 아래와 같은 이유가 발생할 때 <code class=\"language-text\">Refresh Token</code>을 만료시킨다고 한다.</p>\n<p><a href=\"https://developers.google.com/identity/protocols/oauth2#expiration\">Refresh Token 만료</a></p>\n<ul>\n<li>사용자가 앱의 액세스 권한을 취소한 경우</li>\n<li>Refresh Token이 6개월 동안 사용되지 않은 경우</li>\n<li>사용자가 비밀번호를 변경했으며 Gmail scope가 포함된 경우</li>\n<li>사용자가 계정에 부여된 Refresh Token 한도를 초과한 경우</li>\n<li>세션 제어 정책이 적용되는 Google Cloud Platform 조직에 사용자가 속해있는 경우</li>\n</ul>\n<p>정리하면 <code class=\"language-text\">Refresh Token</code>은 만료 기간이 비교적 길기 때문에 서버 측에서 안전하게 보관하며 필요할 때 리소스 접근을 위한 <code class=\"language-text\">Access Token</code>을 발급 받는 형태를 구상하게 되었다.</p>\n<p>우리 <a href=\"https://github.com/woowacourse-teams/2022-dallog\">달록</a>은 아래와 같은 형태로 인증이 이루어진다. </p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/4c02b6ded86cbf0190013659f8371f6c/c7a69/oauth-flow.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 56.470588235294116%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAABcElEQVR42p1T2W7CQAzM/38VSLzRhoJCCCkBKs7cF+Tgmu5YDUrpJdWSs47XO54dJ9pwOESv10On00G320W/38dut0Nj5/MZWZoiyzKJ/zJtu92CoKZpIgxDXC4X8TzPkSQJoijCk/4MXTn3gyCQfNvYjPnT6QSNBy3Lwn6/FwZlWcoGG202G7ieB2NqYTQaSW4wGGA+n+N2u90Bl8slDMMQYI2Juq5RFIUkCJyqK8ZxLCvd93y4rovj8SgN22C06/UqJOTKfPCFTAnK2Pd9jMdjccdxUCiQqqoEkDWPxgaNvlojPAubA2S5WCzEndkMeZrJXn44CPB3gNT9DkjKZMXh0J91Xa5YlRUW6zWmqze8GCOYivFPgJ8YNpNlki6xuvpBaZrXFfxTgVXgIVYTr1X+UcMvDAlyL/pYgziC9WoLwEXl6qZRu/Y3hu0iRmFdwM0SmXxz6LGWA+QXQhnolE7DP6wBtG0bk8lEfgqu1P0dAqFPCz/amuUAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='oauth flow' title='' src='/static/4c02b6ded86cbf0190013659f8371f6c/ca1dc/oauth-flow.png' srcset='/static/4c02b6ded86cbf0190013659f8371f6c/e7570/oauth-flow.png 170w,\n/static/4c02b6ded86cbf0190013659f8371f6c/f46e7/oauth-flow.png 340w,\n/static/4c02b6ded86cbf0190013659f8371f6c/ca1dc/oauth-flow.png 680w,\n/static/4c02b6ded86cbf0190013659f8371f6c/02d09/oauth-flow.png 1020w,\n/static/4c02b6ded86cbf0190013659f8371f6c/9d567/oauth-flow.png 1360w,\n/static/4c02b6ded86cbf0190013659f8371f6c/c7a69/oauth-flow.png 2560w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p><em>달록팀 후디 고마워요!</em></p>\n</blockquote>\n<p>프론트 측에서 <code class=\"language-text\">OAuth 인증</code>을 위해서는 달록 서버에서 제공하는 <code class=\"language-text\">OAuth 인증을 위한 페이지 uri</code>을 활용해야 한다. 달록 서버는 해당 uri를 생성하여 전달한다. 로직은 아래 코드로 구현되어 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 브라우저에서 해당 uri에 접속하면 아래와 같은 페이지를 확인할 수 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/7b4590a4b46a14708d45e7589d075bf7/b2dbf/google-oauth-uri.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 111.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAWCAYAAADAQbwGAAAACXBIWXMAABYlAAAWJQFJUiTwAAABvUlEQVR42rVUy27CMBDk2/szvfQLeumpUm8I2kMFoiQhD+dJAoKYJPZ01ygFVBoCopZWseXN2Due2YFWCrWU2O0qSLnDdrvFZrNBWUpaSyja11r3jkFTV8iLDNmygBACURQhCATSNEWaZajrujcYHz5oFE2gwaPdOJ5z0nFcBFRqD3CPYUq+BDgev2M4HGI6nWI0GqNpmtsBufokyeD6AXEbG47LsuwHqI/4acEmosaHrzATErazoHBg2/ZtNzwQrU8O6s1h8faJtSUQJBEykotJaBOPDugCPgGcPzwifhlhkYRwbAdhGCJOUgJfGsHf9MoN8bh3yI7csiXXlGbN4ua8rvgFKJ9esRnNMPNcCHIKbzaNMjJhwV59w+p5CDnxEBc5ojBGQtbzg4DKTpDn+fWA5FjUpuTSNAVuElVVnbx4V/wAclk8uMx8mWPhenBIc19z6/DaWl9/w9bcXY3hz9C6v5dvbg5MPpdrWTaiODFls3c9zzfB+y7tc69kOsIwMhr1fB+r9cpgnLQvTpxToggFAbtwCYS//DPPnYW755e+Fgm/KArj/72s9HkOz0Wrw5bTLgv+F4cK9woG/Ab1bLzGr+Y1pgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google oauth uri' title='' src='/static/7b4590a4b46a14708d45e7589d075bf7/ca1dc/google-oauth-uri.png' srcset='/static/7b4590a4b46a14708d45e7589d075bf7/e7570/google-oauth-uri.png 170w,\n/static/7b4590a4b46a14708d45e7589d075bf7/f46e7/google-oauth-uri.png 340w,\n/static/7b4590a4b46a14708d45e7589d075bf7/ca1dc/google-oauth-uri.png 680w,\n/static/7b4590a4b46a14708d45e7589d075bf7/b2dbf/google-oauth-uri.png 946w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>계정을 선택하면 <code class=\"language-text\">redirect uri</code>와 함께 <code class=\"language-text\">code</code> 값이 전달되고, google의 token을 발급 받기 위해 백엔드 서버로 <code class=\"language-text\">code</code> 정보를 전달하게 된다. 아래는 실제 code 정보를 기반으로 google token을 생성한 뒤 <code class=\"language-text\">id token</code>에 명시된 정보를 기반으로 회원을 생성 or 조회한 뒤 <code class=\"language-text\">달록 리소스에 접근하기 위한 access token</code>을 발급해주는 API이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@RequestMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/api/auth\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token annotation punctuation\">@RestController</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">AuthController</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">AuthController</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">AuthService</span> authService<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>authService <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token annotation punctuation\">@PostMapping</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/{oauthProvider}/token\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TokenResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">generateToken</span><span class=\"token punctuation\">(</span><span class=\"token annotation punctuation\">@PathVariable</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> oauthProvider<span class=\"token punctuation\">,</span>\n                                                       <span class=\"token annotation punctuation\">@RequestBody</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">TokenRequest</span> tokenRequest<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">TokenResponse</span> tokenResponse <span class=\"token operator\">=</span> authService<span class=\"token punctuation\">.</span><span class=\"token function\">generateToken</span><span class=\"token punctuation\">(</span>tokenRequest<span class=\"token punctuation\">.</span><span class=\"token function\">getCode</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token punctuation\">.</span><span class=\"token function\">ok</span><span class=\"token punctuation\">(</span>tokenResponse<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">authService.generateToken(tokenRequest.getCode())</code>: code 정보를 기반으로 google 토큰 정보를 조회한다. 메서드 내부에서 <a href=\"https://developers.google.com/identity/protocols/oauth2/openid-connect#exchangecode\">code을 액세스 토큰 및 ID 토큰으로 교환</a>에서 제공된 형식에 맞춰 google에게 code 정보를 전달하고 토큰 정보를 교환한다. </li>\n</ul>\n<p>실제 Google에서 토큰 정보를 교환 받는 클라이언트를 담당하는 <code class=\"language-text\">GoogleOAuthClient</code>이다. 핵심은 인가 코드를 기반으로 <code class=\"language-text\">GoogleTokenResponse</code>를 발급 받는 다는 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthClient</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthClient</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> <span class=\"token constant\">JWT_DELIMITER</span> <span class=\"token operator\">=</span> <span class=\"token string\">\"\\\\.\"</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplate</span> restTemplate<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> objectMapper<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthClient</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">,</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">RestTemplateBuilder</span> restTemplateBuilder<span class=\"token punctuation\">,</span>\n                             <span class=\"token keyword\">final</span> <span class=\"token class-name\">ObjectMapper</span> objectMapper<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>restTemplate <span class=\"token operator\">=</span> restTemplateBuilder<span class=\"token punctuation\">.</span><span class=\"token function\">build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>objectMapper <span class=\"token operator\">=</span> objectMapper<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">OAuthMember</span> <span class=\"token function\">getOAuthMember</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// code을 액세스 토큰 및 ID 토큰으로 교환</span>\n        <span class=\"token class-name\">GoogleTokenResponse</span> googleTokenResponse <span class=\"token operator\">=</span> <span class=\"token function\">requestGoogleToken</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">String</span> payload <span class=\"token operator\">=</span> <span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span>googleTokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getIdToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">UserInfo</span> userInfo <span class=\"token operator\">=</span> <span class=\"token function\">parseUserInfo</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">String</span> refreshToken <span class=\"token operator\">=</span> googleTokenResponse<span class=\"token punctuation\">.</span><span class=\"token function\">getRefreshToken</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthMember</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getEmail</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> userInfo<span class=\"token punctuation\">.</span><span class=\"token function\">getPicture</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> refreshToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">GoogleTokenResponse</span> <span class=\"token function\">requestGoogleToken</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">HttpHeaders</span> headers <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpHeaders</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        headers<span class=\"token punctuation\">.</span><span class=\"token function\">setContentType</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">MediaType</span><span class=\"token punctuation\">.</span><span class=\"token constant\">APPLICATION_FORM_URLENCODED</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> params <span class=\"token operator\">=</span> <span class=\"token function\">generateTokenParams</span><span class=\"token punctuation\">(</span>code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MultiValueMap</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> request <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">,</span> headers<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">fetchGoogleToken</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">getBody</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">generateTokenParams</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> code<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">MultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span></span> params <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">LinkedMultiValueMap</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_id\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"client_secret\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientSecret</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"code\"</span><span class=\"token punctuation\">,</span> code<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"grant_type\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"authorization_code\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        params<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"redirect_uri\"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> params<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">ResponseEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">GoogleTokenResponse</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">fetchGoogleToken</span><span class=\"token punctuation\">(</span>\n            <span class=\"token keyword\">final</span> <span class=\"token class-name\">HttpEntity</span><span class=\"token generics\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">MultiValueMap</span><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">></span><span class=\"token punctuation\">></span></span> request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> restTemplate<span class=\"token punctuation\">.</span><span class=\"token function\">postForEntity</span><span class=\"token punctuation\">(</span>properties<span class=\"token punctuation\">.</span><span class=\"token function\">getTokenUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> request<span class=\"token punctuation\">,</span> <span class=\"token class-name\">GoogleTokenResponse</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">RestClientException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthException</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">getPayload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> jwt<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JWT_DELIMITER</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">UserInfo</span> <span class=\"token function\">parseUserInfo</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\">String</span> decodedPayload <span class=\"token operator\">=</span> <span class=\"token function\">decodeJwtPayload</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">return</span> objectMapper<span class=\"token punctuation\">.</span><span class=\"token function\">readValue</span><span class=\"token punctuation\">(</span>decodedPayload<span class=\"token punctuation\">,</span> <span class=\"token class-name\">UserInfo</span><span class=\"token punctuation\">.</span><span class=\"token keyword\">class</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span><span class=\"token class-name\">JsonProcessingException</span> e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OAuthException</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"id 토큰을 읽을 수 없습니다.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">String</span> <span class=\"token function\">decodeJwtPayload</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">String</span> payload<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Base64</span><span class=\"token punctuation\">.</span><span class=\"token function\">getUrlDecoder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">StandardCharsets</span><span class=\"token punctuation\">.</span><span class=\"token constant\">UTF_8</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 Google에게 제공 받은 <code class=\"language-text\">Refresh Token</code>을 저장해보자.</p>\n<h2>Refresh Token에 채워진 null</h2>\n<p>이게 무슨 일인가, 분명 요청 형식에 맞춰 헤더를 채워 디버깅을 해보면 계속해서 <code class=\"language-text\">null</code> 값으로 전달되고 있는 것이다. 즉, Google 측에서 Refresh Token을 보내주지 않고 있다는 것을 의미한다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/40821173b75b8bc6f832d00faa388a42/7c559/google-refresh-token-null.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 18.823529411764707%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAhklEQVR42k3P6wrDIAwFYB/MW2JSo7O2bLDt32Dv/xDTWlnh43BUiKo+df+W+swlJglZKEtoRSLfkmcyAS1hyys7N9Wj1PsilMQLGwLL2BjqLAe7BHf4Fz6zUa+17jG5RG2Y9mgANaKGAS7m0sM8RfVet00EMrnYh/ULB57lFMYXxoN7Iv4AiCA/C7lfIAkAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token null' title='' src='/static/40821173b75b8bc6f832d00faa388a42/ca1dc/google-refresh-token-null.png' srcset='/static/40821173b75b8bc6f832d00faa388a42/e7570/google-refresh-token-null.png 170w,\n/static/40821173b75b8bc6f832d00faa388a42/f46e7/google-refresh-token-null.png 340w,\n/static/40821173b75b8bc6f832d00faa388a42/ca1dc/google-refresh-token-null.png 680w,\n/static/40821173b75b8bc6f832d00faa388a42/02d09/google-refresh-token-null.png 1020w,\n/static/40821173b75b8bc6f832d00faa388a42/9d567/google-refresh-token-null.png 1360w,\n/static/40821173b75b8bc6f832d00faa388a42/7c559/google-refresh-token-null.png 1540w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>다시 한번 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#offline\">액세스 토큰 새로고침 (오프라인 액세스)</a>를 살펴보았다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/fd2dd90efd7002666575df63734befc8/dff2b/google-refresh-token-docs.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 61.1764705882353%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACBUlEQVR42o1T2XLbMAzU/39fJ3Ej675F3Yd1eOLtLpU0faxnYAIiCAK7S8cYgziOUdU10jS1fp7nyLKMfoKiKOy3aZrwPz/n8Xhgnhcsy2LXeZ4xjuOPsVDfDxiGAeu6Mm+1ufJ1VqvOTNOMbdvhqJu3t3fc7x4+Ply47t3GURQhSVL4fkA/hud5tlN1LQu5r7P69r3f9z2cbdtQVSUajl5yPEHQNA1v33AcB/Z9t+vz+bS+8vf9sN3JFMuO48TniyNr7nZYkZQjsrpnVwlyFk7TzHaobhLbWYy6qjARhmHo0bYtO+qsPxKOflxwPF9fBfsRpenQdCOKskLJgyVXYxprVbegaB9o5xPzDqwH8Dhf1p/pq9h5Hhcp+ivqFjcvg+uFxCMknndi6Vpc3LsPN0zx24vw6+bDoy8LIuJLu7kBPoi7HxdY98+fkcO8RxjniMKIRPh2XIEeMg7DkBYgTWKySkWQ1YvphUoYMC9XLJwd6aslCY2piUuDtutgGhJDjESOrCxL7nWoa2Pl03U9iay4ZyyzipVnCwp8SSWhqP0gQBBcMvkrB3YbUCIe5eMSCqmg5iNQQfnC2/AixVKBM5A1saouNKKSxaAuMs1FSi1ieEgF/hX1OF2jSjZaz/OE03FEYSR5SMR5XlhRfwvbipg46lnqOfpBiOArT+MLMl2gVyW9/gFPPoYWNEOILwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token docs' title='' src='/static/fd2dd90efd7002666575df63734befc8/ca1dc/google-refresh-token-docs.png' srcset='/static/fd2dd90efd7002666575df63734befc8/e7570/google-refresh-token-docs.png 170w,\n/static/fd2dd90efd7002666575df63734befc8/f46e7/google-refresh-token-docs.png 340w,\n/static/fd2dd90efd7002666575df63734befc8/ca1dc/google-refresh-token-docs.png 680w,\n/static/fd2dd90efd7002666575df63734befc8/dff2b/google-refresh-token-docs.png 767w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>정리하면 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#redirecting\">Google OAuth 2.0 서버로 리디렉션</a>할 때 query parameter에 <code class=\"language-text\">access_type</code>을 <code class=\"language-text\">offline</code>으로 설정해야 한다는 것이다. 다시 되돌아 가서 Google 인증 요청을 위한 uri를 생성하는 메서드를 아래와 같이 수정하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"access_type=offline\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가된 부분</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 다시 요청을 진행해보자! 분명 <code class=\"language-text\">refresh token</code>이 정상적으로 교환될 것이다.</p>\n<h2>또 다시 Refresh Token에 채워진 null</h2>\n<p>분명 문서에 명시한 대로 설정을 진행했지만 아직도 동일하게 <code class=\"language-text\">null</code> 값이 채워져 있다.</p>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/f0a948c22b5527c308e2c44e13f5f8d7/5b400/google-refresh-token-null-2.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 38.23529411764706%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAABYlAAAWJQFJUiTwAAABI0lEQVR42m2Q3W7DIAyF81rr2iSAAWObpknX/66r1KXa3v8FZpJd7GLS0dHHMZYx1R7pxvmd8ynJhfKF5JLyHsUGDIlnefx1iCmSAiFn67HK4+M6vN2S3GX9yN2BcsQY2Tv2kINfo5MAXQRRjpooWPEaGvYVPMd+05+RrpzvnLtAniSKvLZm1lLdTD6rKceZq/Acd5vhTnIkIUwBPQgGSU1wbYTiqOCa6NqJFTSc8yqM49BtrshnEgOhRmdFe2wNtvGu9rYuXm4X0Hwq1VASnfx56LcfJPrmbZImeG3W8qI2i2W7WP0rM6mt8Ptr12/LszkPxDYFy6BfUka5MmTl5lEF/rJ6ZY8nYdmFFDy+gClbzSulaVssYBIYhmZauE1QNJV+ALIohSgo9D6LAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token null 2' title='' src='/static/f0a948c22b5527c308e2c44e13f5f8d7/ca1dc/google-refresh-token-null-2.png' srcset='/static/f0a948c22b5527c308e2c44e13f5f8d7/e7570/google-refresh-token-null-2.png 170w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/f46e7/google-refresh-token-null-2.png 340w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/ca1dc/google-refresh-token-null-2.png 680w,\n/static/f0a948c22b5527c308e2c44e13f5f8d7/5b400/google-refresh-token-null-2.png 770w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<blockquote>\n<p><em>해달라는 데로 다해줬는데...</em></p>\n</blockquote>\n<h2>엄격한 Google</h2>\n<p>Google은 OAuth 2.0을 통해 인증을 받을 때 Refresh Token을 굉장히 엄격하게 다룬다. 사용자가 로그인을 진행할 때 마다 Refresh Token 정보를 주는 것이 아니라, Google에 등록된 App에 최초 로그인 할 때만 제공해준다. 즉, 재로그인을 진행해도 Refresh Token은 발급해주지 않는다. </p>\n<p>Google의 의도대로 동작하려면 내가 우리 서비스에 최초로 로그인을 진행하는 시점에만 Refresh Token을 발급받고 서버 내부에 저장한 뒤 필요할 때 꺼내 사용해야 한다.</p>\n<p>하지만 우리 서버는 모종의 이유로 최초에 받아온 Refresh Token을 저장하지 못할 수 있다. 이때 <a href=\"https://developers.google.com/identity/protocols/oauth2/web-server#redirecting\">Google OAuth 2.0 서버로 리디렉션</a>할 때 <code class=\"language-text\">prompt</code>를 <code class=\"language-text\">consent</code>로 설정하게 되면 매 로그인 마다 사용자에게 동의를 요청하기 때문에 강제로 <code class=\"language-text\">Refresh Token</code>을 받도록 지정할 수 있다.</p>\n<p>이제 진짜 마지막이다. 아래와 같이 수정한 뒤 다시 디버깅을 진행하였다.</p>\n<div class=\"gatsby-highlight\" data-language=\"java\"><pre class=\"language-java\"><code class=\"language-java\"><span class=\"token annotation punctuation\">@Component</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GoogleOAuthUri</span> <span class=\"token keyword\">implements</span> <span class=\"token class-name\">OAuthUri</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">GoogleOAuthUri</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">final</span> <span class=\"token class-name\">GoogleProperties</span> properties<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>properties <span class=\"token operator\">=</span> properties<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token annotation punctuation\">@Override</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">String</span> <span class=\"token function\">generate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getOAuthEndPoint</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"?\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"client_id=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getClientId</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"redirect_uri=\"</span> <span class=\"token operator\">+</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getRedirectUri</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"response_type=code&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"scope=\"</span> <span class=\"token operator\">+</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">\" \"</span><span class=\"token punctuation\">,</span> properties<span class=\"token punctuation\">.</span><span class=\"token function\">getScopes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">\"&amp;\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"access_type=offline\"</span>\n                <span class=\"token operator\">+</span> <span class=\"token string\">\"prompt=consent\"</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 추가된 부분</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><span class='gatsby-resp-image-wrapper' style='position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 680px; margin-bottom: 16px;'>\n      <a class='gatsby-resp-image-link' href='/static/ac7268ed5711abec2e8ce73110f7c556/e4da8/google-refresh-token-success.png' style='display: block' target='_blank' rel='noopener'>\n    <span class='gatsby-resp-image-background-image' style=\"padding-bottom: 37.05882352941176%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA50lEQVR42m2Q/W7CMAzE+1yDdfl2bCeB/cUGiE5aK97/DbDTIqFp0k/R9dzLuR0wpe92/CntynViPRWqFclnTETAJRELwJyQREQUU8/BpIz35VTaBctU2o1rTmgxOg4WgyvhVXTiZnIYbIQ4z+d2kNiFioYBR9CZo2BJXzXorWpve+ZJlGaAZT7Vw43KZ5ZVk97dx4YUiekjbW3qoyKXDiZC3sL1i4qLyZCXwd7ZvfmfXUfE2vx7bscrFvltNfMIXkrG6N7erTL+ZdcRoc2wLNI8UeWMgdK6oe6W+6eqCB/g123FXBHnAQy9dV2QTJc1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"></span>\n  <img class='gatsby-resp-image-image' alt='google refresh token success' title='' src='/static/ac7268ed5711abec2e8ce73110f7c556/ca1dc/google-refresh-token-success.png' srcset='/static/ac7268ed5711abec2e8ce73110f7c556/e7570/google-refresh-token-success.png 170w,\n/static/ac7268ed5711abec2e8ce73110f7c556/f46e7/google-refresh-token-success.png 340w,\n/static/ac7268ed5711abec2e8ce73110f7c556/ca1dc/google-refresh-token-success.png 680w,\n/static/ac7268ed5711abec2e8ce73110f7c556/e4da8/google-refresh-token-success.png 766w' sizes='(max-width: 680px) 100vw, 680px' style='width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;' loading='lazy' decoding='async'>\n  </a>\n    </span></p>\n<p>정상적으로 발급 되는 것을 확인할 수 있다!</p>\n<h2>문제점</h2>\n<p>하지만 여기서 문제가 하나 있다. 단순히 <code class=\"language-text\">prompt</code>를 <code class=\"language-text\">consent</code>로 설정할 경우 우리 서비스에 가입된 사용자는 Google OAuth 2.0 인증을 진행할 때 매번 재로그인을 진행해야 한다. 이것은 사용자에게 매우 <code class=\"language-text\">불쾌한 경험</code>으로 다가올 수 있다. 즉 우리는 매번 <code class=\"language-text\">재로그인</code>을 통해 Refresh Token을 발급 받는 것이 아닌, 최초 로그인 시 <code class=\"language-text\">Refresh Token</code>을 발급 받은 뒤 적절한 저장소에 저장하고 관리해야 한다.</p>\n<p>그렇다면 실제 운영 환경이 아닌 테스트 환경에서는 어떻게 해야 할까? 운영 환경과 동일한 <code class=\"language-text\">Google Cloud Project</code>를 사용할 경우 최초 로그인을 진행할 때 <code class=\"language-text\">내 권한 정보가 등록</code>된다. 즉 Refresh Token을 재발급 받을 수 없다는 것을 의미한다. </p>\n<p>우리 달록은 운영 환경과 테스트 환경에서 서로 다른 <code class=\"language-text\">Google Cloud Project</code>를 생성하여 관리하는 방향에 대해 고민하고 있다. 이미 Spring Profile 기능을 통해 각 실행 환경에 대한 설정을 분리해두었기 때문에 쉽게 적용이 가능할 것이라 기대한다. 정리하면 아래와 같다.</p>\n<ul>\n<li><code class=\"language-text\">운영 환경</code>: Refresh Token 발급을 위해 <code class=\"language-text\">accept_type</code>을 <code class=\"language-text\">offline</code>으로 설정한다. 단 최초 로그인에만 Refresh Token을 발급 받기 위해 <code class=\"language-text\">prompt</code>는 명시하지 않는다.</li>\n<li><code class=\"language-text\">개발 환경</code>: 개발 환경에서는 매번 DataBase가 초기화 되기 때문에 Refresh Token을 유지하여 관리할 수 없다. 테스트를 위한 추가적인 <code class=\"language-text\">Google Cloud Project</code>를 생성한 뒤, <code class=\"language-text\">accept_type</code>을 <code class=\"language-text\">offline</code>으로, <code class=\"language-text\">prompt</code>는 <code class=\"language-text\">consent</code>로 설정하여 매번 새롭게 Refresh Token을 받도록 세팅한다.</li>\n</ul>\n<h2>정리</h2>\n<p>영어를 번역기로 해석한 수준의 문장으로 인해 많은 시간을 삽질하게 되었다. 덕분에 Google에서 의도하는 Refresh Token에 대한 사용 방식과 어디에서 저장하고 관리해야 하는지에 대해 좀 더 깊은 고민을 할 수 있게 되었다. 만약 나와 같은 상황에 직면한 사람이 있다면 이 글이 도움이 되길 바란다!</p>\n<h2>References.</h2>\n<p><a href=\"https://github.com/woowacourse-teams/2022-dallog\">dallog repository</a><br>\n<a href=\"https://github.com/devHudi\">https://github.com/devHudi</a><br>\n<a href=\"https://m.blog.naver.com/dldbdgml99/222013891067\">passport.js에서 구글 OAuth 진행 시 Refresh Token을 못 받아오는 문제 해결</a><br></p>","frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다.","date":"August 16, 2022","update":"August 16, 2022","tags":["우아한테크코스","달록","OAuth","OpenId","refresh token"],"series":null},"fields":{"slug":"/google-refresh-token/","readingTime":{"minutes":12.39}}},"seriesList":{"edges":[{"node":{"id":"2dac6856-47a1-5ef0-9c9f-d69d4234afcf","fields":{"slug":"/why-jdbc-template/"},"frontmatter":{"title":"JdbcTemplate는 어디에?"}}},{"node":{"id":"b77737b7-c888-54d0-8901-9921b4bbb703","fields":{"slug":"/spring-jdbc-batch/"},"frontmatter":{"title":"Spring JDBC로 batch 활용하기"}}},{"node":{"id":"59e94329-3d48-53b9-9995-90d61432234d","fields":{"slug":"/local-date-time/"},"frontmatter":{"title":"java에서 날짜, 시간 제대로 사용하기"}}},{"node":{"id":"c8dda97d-41c7-5596-a0c8-703fd69d92e7","fields":{"slug":"/identity-strategy/"},"frontmatter":{"title":"IDENTITY 전략는 추가 조회를 하지 않을 수 있다."}}},{"node":{"id":"c50af7e8-5953-5168-b4af-1d186a4254a7","fields":{"slug":"/separated-interface/"},"frontmatter":{"title":"외부와 의존성 분리하기"}}},{"node":{"id":"ba9d009e-d6e8-574f-9f7b-89819e3e57ca","fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}}},{"node":{"id":"7b780208-a850-5305-a51c-f0937cbdaf93","fields":{"slug":"/google-refresh-token/"},"frontmatter":{"title":"Google은 Refresh Token을 쉽게 내주지 않는다."}}},{"node":{"id":"58f32f4d-b2d6-54d6-b3dd-cb4cf4da1d70","fields":{"slug":"/basic-tomcat/"},"frontmatter":{"title":"Tomcat"}}},{"node":{"id":"d26e840e-0646-5dd9-a2d5-5670ddc81ede","fields":{"slug":"/jdbc/"},"frontmatter":{"title":"JDBC"}}},{"node":{"id":"e0a32367-096e-595a-9580-0d3d2fc6e9aa","fields":{"slug":"/template-callback/"},"frontmatter":{"title":"jdbcTemplate을 만들며 마주한 Template Callback 패턴"}}},{"node":{"id":"fa938264-2615-556e-bcfa-d749c30aa8fe","fields":{"slug":"/covering-index/"},"frontmatter":{"title":"커버링 인덱스"}}},{"node":{"id":"cf3a2936-1b1f-5d11-832e-dbb9f8051755","fields":{"slug":"/osiv/"},"frontmatter":{"title":"OSIV와 사용하며 직면한 문제"}}},{"node":{"id":"53859931-2807-5303-a90d-33df33a856de","fields":{"slug":"/save-persist-merge/"},"frontmatter":{"title":"SimpleJpaRepository의 save()는 어떻게 새로운 엔티티를 판단할까?"}}},{"node":{"id":"09a96ca9-bb95-55ab-83cf-d9d053b2ad70","fields":{"slug":"/optimistic-locking/"},"frontmatter":{"title":"낙관적 락과 동시성 테스트"}}},{"node":{"id":"647737e4-08ec-5813-a092-c27ef1da4292","fields":{"slug":"/java-string/"},"frontmatter":{"title":"문자열 생성 방식 비교하기"}}},{"node":{"id":"696ee6ba-c2ea-5e8b-a25f-aaa4eccfa5e9","fields":{"slug":"/2022-retrospect/"},"frontmatter":{"title":"조금 늦은 2022년 회고"}}},{"node":{"id":"5a61e41a-16ff-5669-bf0e-028ea40e0af3","fields":{"slug":"/jpa-auditing/"},"frontmatter":{"title":"Spring Data JPA Auditing"}}}]},"previous":{"fields":{"slug":"/properties-to-object/"},"frontmatter":{"title":"properties 객체로 다루기"}},"next":{"fields":{"slug":"/basic-tomcat/"},"frontmatter":{"title":"Tomcat"}}},"pageContext":{"id":"7b780208-a850-5305-a51c-f0937cbdaf93","series":null,"previousPostId":"ba9d009e-d6e8-574f-9f7b-89819e3e57ca","nextPostId":"58f32f4d-b2d6-54d6-b3dd-cb4cf4da1d70"}},"staticQueryHashes":[],"slicesMap":{}}